<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ›¿æ¢å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .drop-zones {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .drop-zone {
            border: 3px dashed #4facfe;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
            cursor: pointer;
        }
        
        .drop-zone:hover {
            border-color: #667eea;
            background: #e9ecef;
            transform: translateY(-2px);
        }
        
        .drop-zone.drag-over {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .drop-zone h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .drop-zone p {
            color: #6c757d;
            margin-bottom: 20px;
        }
        
        .file-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            text-align: left;
        }
        
        .file-info h4 {
            color: #495057;
            margin-bottom: 8px;
        }
        
        .file-info p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .instructions {
            background: #e7f3ff;
            border-left: 4px solid #4facfe;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .instructions h3 {
            color: #495057;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #6c757d;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .manual-steps {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .manual-steps h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .manual-steps ol {
            margin-left: 20px;
            color: #856404;
        }
        
        .manual-steps li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 768px) {
            .drop-zones {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ æ–‡ä»¶æ›¿æ¢å·¥å…·</h1>
            <p>è½»æ¾æ›¿æ¢downloaded_imagesæ–‡ä»¶å¤¹ä¸­çš„é”™è¯¯æ–‡ä»¶</p>
        </div>
        
        <div class="content">
            <div class="instructions">
                <h3>ä½¿ç”¨è¯´æ˜</h3>
                <ol>
                    <li>ç‚¹å‡»<strong>"æˆæƒè®¿é—®æ–‡ä»¶å¤¹"</strong>æŒ‰é’®ï¼Œé€‰æ‹©downloaded_imagesæ–‡ä»¶å¤¹è¿›è¡Œæˆæƒ</li>
                    <li>åœ¨ <strong>AåŒº</strong> æ‹–å…¥éœ€è¦æ›¿æ¢çš„é”™è¯¯æ–‡ä»¶ï¼ˆæ¥è‡ªdownloaded_imagesæ–‡ä»¶å¤¹ï¼‰</li>
                    <li>åœ¨ <strong>BåŒº</strong> æ‹–å…¥æ­£ç¡®çš„æ›¿æ¢æ–‡ä»¶ <strong>æˆ– ç²˜è´´å¤åˆ¶çš„å›¾ç‰‡</strong></li>
                    <li>ç‚¹å‡»<strong>"è‡ªåŠ¨æ‰§è¡Œæ›¿æ¢"</strong>æŒ‰é’®å®Œæˆæ–‡ä»¶æ›¿æ¢</li>
                </ol>
                <p style="margin-top: 10px; color: #495057; font-size: 0.9em;">
                    <strong>æ³¨æ„ï¼š</strong>æ­¤å·¥å…·ä½¿ç”¨æµè§ˆå™¨çš„File System Access APIï¼Œæ— éœ€åç«¯æœåŠ¡å™¨å³å¯ç›´æ¥æ“ä½œæ–‡ä»¶ã€‚
                </p>
            </div>
            
            <div class="drop-zones">
                <div class="drop-zone" id="zoneA" data-zone="A">
                    <h3>ğŸ”„ AåŒº - é”™è¯¯æ–‡ä»¶</h3>
                    <p>æ‹–å…¥éœ€è¦æ›¿æ¢çš„é”™è¯¯æ–‡ä»¶</p>
                    <div class="file-info" id="infoA" style="display: none;">
                        <h4>å·²é€‰æ‹©æ–‡ä»¶ï¼š</h4>
                        <p id="fileNameA"></p>
                        <p id="fileSizeA"></p>
                    </div>
                </div>
                
                <div class="drop-zone" id="zoneB" data-zone="B">
                    <h3>âœ… BåŒº - æ­£ç¡®æ–‡ä»¶</h3>
                    <p>æ‹–å…¥æ­£ç¡®çš„æ›¿æ¢æ–‡ä»¶ æˆ– ç²˜è´´å¤åˆ¶çš„å›¾ç‰‡</p>
                    <div class="file-info" id="infoB" style="display: none;">
                        <h4>å·²é€‰æ‹©æ–‡ä»¶ï¼š</h4>
                        <p id="fileNameB"></p>
                        <p id="fileSizeB"></p>
                    </div>
                </div>
            </div>
            
        <div class="controls">
            <button class="btn" id="authBtn">æˆæƒè®¿é—®æ–‡ä»¶å¤¹</button>
            <button class="btn" id="replaceBtn" disabled>è‡ªåŠ¨æ‰§è¡Œæ›¿æ¢</button>
        </div>
            
            <div class="status" id="status"></div>
            
            <div class="manual-steps" id="manualSteps" style="display: none;">
                <h3>ğŸ“‹ æ‰‹åŠ¨æ›¿æ¢æ­¥éª¤</h3>
                <ol id="stepsList">
                    <!-- æ­¥éª¤å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </ol>
            </div>
        </div>
    </div>

    <script>
        let fileA = null;
        let fileB = null;
        let dirHandle = null; // å­˜å‚¨ç›®å½•å¥æŸ„
        
        // æˆæƒæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('authBtn').addEventListener('click', async function() {
            try {
                // å¼¹å‡ºé€‰æ‹©ç›®å½•çš„å¯¹è¯æ¡†ï¼Œç”¨æˆ·æˆäºˆè®¿é—®æƒé™
                dirHandle = await window.showDirectoryPicker();
                
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status success';
                statusDiv.textContent = 'æ–‡ä»¶å¤¹è®¿é—®æˆæƒæˆåŠŸï¼ç°åœ¨å¯ä»¥æ‰§è¡Œæ–‡ä»¶æ›¿æ¢æ“ä½œã€‚';
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                this.textContent = 'å·²æˆæƒ';
                this.disabled = true;
                this.style.background = '#28a745';
                
                console.log('ç›®å½•æˆæƒæˆåŠŸ:', dirHandle);
                
            } catch (err) {
                console.error('æˆæƒå¤±è´¥:', err);
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status error';
                statusDiv.textContent = 'æˆæƒå¤±è´¥æˆ–æ“ä½œå·²å–æ¶ˆ: ' + (err.message || 'æœªçŸ¥é”™è¯¯');
            }
        });
        
        // åˆå§‹åŒ–æ‹–æ”¾åŒºåŸŸ
        const zones = document.querySelectorAll('.drop-zone');
        zones.forEach(zone => {
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
        });

        // ä¸ºBåŒºæ·»åŠ ç²˜è´´äº‹ä»¶ç›‘å¬å™¨ - åœ¨é¼ æ ‡æ‚¬åœæ—¶ç›‘å¬ç²˜è´´
        const zoneB = document.getElementById('zoneB');
        let pasteListenerActive = false;
        
        // é¼ æ ‡è¿›å…¥BåŒºæ—¶æ¿€æ´»ç²˜è´´ç›‘å¬
        zoneB.addEventListener('mouseenter', function() {
            if (!pasteListenerActive) {
                document.addEventListener('paste', handlePaste);
                pasteListenerActive = true;
                console.log('ç²˜è´´ç›‘å¬å·²æ¿€æ´»');
            }
        });
        
        // é¼ æ ‡ç¦»å¼€BåŒºæ—¶ç§»é™¤ç²˜è´´ç›‘å¬
        zoneB.addEventListener('mouseleave', function() {
            if (pasteListenerActive) {
                document.removeEventListener('paste', handlePaste);
                pasteListenerActive = false;
                console.log('ç²˜è´´ç›‘å¬å·²ç§»é™¤');
            }
        });
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const zone = e.currentTarget.id;
                const file = files[0];
                
                if (zone === 'zoneA') {
                    fileA = file;
                    displayFileInfo('A', file);
                } else if (zone === 'zoneB') {
                    fileB = file;
                    displayFileInfo('B', file);
                }
                
                updateReplaceButton();
            }
        }

        function handlePaste(e) {
            e.preventDefault();
            console.log('ç²˜è´´äº‹ä»¶è§¦å‘');
            
            const clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) {
                console.log('ä¸æ”¯æŒå‰ªè´´æ¿API');
                return;
            }
            
            const items = clipboardData.items;
            console.log('å‰ªè´´æ¿é¡¹ç›®æ•°é‡:', items.length);
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                console.log('å‰ªè´´æ¿é¡¹ç›®ç±»å‹:', item.type);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡ç±»å‹
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    if (file) {
                        console.log('æˆåŠŸè·å–æ–‡ä»¶:', file.name);
                        fileB = file;
                        displayFileInfo('B', file);
                        updateReplaceButton();
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        const statusDiv = document.getElementById('status');
                        statusDiv.style.display = 'block';
                        statusDiv.className = 'status success';
                        statusDiv.textContent = 'å›¾ç‰‡å·²æˆåŠŸç²˜è´´åˆ°BåŒºï¼';
                        
                        setTimeout(() => {
                            statusDiv.style.display = 'none';
                        }, 2000);
                    } else {
                        console.log('æ— æ³•è·å–æ–‡ä»¶å¯¹è±¡');
                    }
                    break; // åªå¤„ç†ç¬¬ä¸€ä¸ªå›¾ç‰‡
                }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡ï¼Œæ˜¾ç¤ºæç¤º
            if (!fileB) {
                const statusDiv = document.getElementById('status');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status info';
                statusDiv.textContent = 'æœªæ£€æµ‹åˆ°å›¾ç‰‡ï¼Œè¯·ç¡®ä¿å¤åˆ¶çš„æ˜¯å›¾ç‰‡æ–‡ä»¶';
                
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }
        
        function displayFileInfo(zone, file) {
            const infoDiv = document.getElementById(`info${zone}`);
            const fileName = document.getElementById(`fileName${zone}`);
            const fileSize = document.getElementById(`fileSize${zone}`);
            
            fileName.textContent = file.name;
            fileSize.textContent = `å¤§å°: ${formatFileSize(file.size)}`;
            infoDiv.style.display = 'block';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function updateReplaceButton() {
            const replaceBtn = document.getElementById('replaceBtn');
            replaceBtn.disabled = !(fileA && fileB);
        }
        
        // æ›¿æ¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨File System Access APIæ‰§è¡Œæ–‡ä»¶æ›¿æ¢
        document.getElementById('replaceBtn').addEventListener('click', async function() {
            if (!fileA || !fileB) return;
            
            const statusDiv = document.getElementById('status');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status info';
            statusDiv.textContent = 'æ­£åœ¨æ‰§è¡Œæ–‡ä»¶æ›¿æ¢æ“ä½œ...';
            
            try {
                // æ£€æŸ¥æ˜¯å¦å·²æˆæƒ
                if (!dirHandle) {
                    throw new Error('è¯·å…ˆæˆæƒè®¿é—®æ–‡ä»¶å¤¹');
                }
                
                // 1. åˆ é™¤åŸæ–‡ä»¶ï¼ˆAåŒºæ–‡ä»¶ï¼‰
                try {
                    await dirHandle.removeEntry(fileA.name);
                    console.log('åŸæ–‡ä»¶å·²åˆ é™¤:', fileA.name);
                } catch (err) {
                    console.warn('åˆ é™¤åŸæ–‡ä»¶å¤±è´¥ï¼Œå¯èƒ½æ–‡ä»¶ä¸å­˜åœ¨:', err);
                }
                
                // 2. åˆ›å»ºæ–°æ–‡ä»¶ï¼ˆBåŒºæ–‡ä»¶ï¼‰ï¼Œä½¿ç”¨åŸæ–‡ä»¶å
                const newFileHandle = await dirHandle.getFileHandle(fileA.name, { create: true });
                const writable = await newFileHandle.createWritable();
                
                // å°†BåŒºæ–‡ä»¶å†…å®¹å†™å…¥æ–°æ–‡ä»¶
                const fileBArrayBuffer = await fileB.arrayBuffer();
                await writable.write(fileBArrayBuffer);
                await writable.close();
                
                console.log('æ–°æ–‡ä»¶å·²åˆ›å»º:', fileA.name);
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                statusDiv.className = 'status success';
                statusDiv.innerHTML = `
                    <strong>æ–‡ä»¶æ›¿æ¢æˆåŠŸï¼</strong><br>
                    å·²æˆåŠŸå°† ${fileA.name} æ›¿æ¢ä¸ºæ–°çš„æ–‡ä»¶ã€‚<br>
                    åŸæ–‡ä»¶å·²åˆ é™¤ï¼Œæ–°æ–‡ä»¶å·²é‡å‘½åå¹¶ä¿å­˜åˆ°æ­£ç¡®ä½ç½®ã€‚
                `;
                
                // é‡ç½®æ–‡ä»¶é€‰æ‹©
                fileA = null;
                fileB = null;
                document.getElementById('infoA').style.display = 'none';
                document.getElementById('infoB').style.display = 'none';
                updateReplaceButton();
                
            } catch (error) {
                console.error('æ–‡ä»¶æ›¿æ¢å¤±è´¥:', error);
                statusDiv.className = 'status error';
                statusDiv.textContent = `æ–‡ä»¶æ›¿æ¢å¤±è´¥: ${error.message}`;
            }
        });
        
        // ç‚¹å‡»åŒºåŸŸé€‰æ‹©æ–‡ä»¶
        zones.forEach(zone => {
            zone.addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '*/*';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const zoneId = zone.id;
                        if (zoneId === 'zoneA') {
                            fileA = file;
                            displayFileInfo('A', file);
                        } else if (zoneId === 'zoneB') {
                            fileB = file;
                            displayFileInfo('B', file);
                        }
                        updateReplaceButton();
                    }
                };
                input.click();
            });
        });
    </script>
</body>
</html>
